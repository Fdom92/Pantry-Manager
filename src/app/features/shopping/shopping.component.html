<ion-header>
  <ion-toolbar>
    <ion-title>Compras</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  @let state = shoppingState();

  <ion-card>
    <ion-card-header class="summary-card-header">
      <div class="summary-header-content">
        <div class="summary-header-top">
          <ion-card-title>Resumen de compras</ion-card-title>
          <ion-button
            fill="clear"
            size="small"
            (click)="toggleSummary()"
            class="summary-toggle"
            [aria-expanded]="summaryExpanded()"
            [attr.aria-label]="summaryExpanded() ? 'Contraer resumen' : 'Expandir resumen'"
          >
            <ion-icon [name]="summaryExpanded() ? 'chevron-up-outline' : 'chevron-down-outline'" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        @if (state.hasAlerts) {
          <ion-card-subtitle>
            {{ state.summary.total }}
            {{ state.summary.total === 1 ? 'producto' : 'productos' }}
            para comprar en
            {{ state.summary.supermarketCount }}
            {{ state.summary.supermarketCount === 1 ? 'supermercado' : 'supermercados' }}.
          </ion-card-subtitle>
        } @else {
          <ion-card-subtitle>Todos los artículos almacenados cumplen sus objetivos.</ion-card-subtitle>
        }
      </div>
    </ion-card-header>
    <ion-card-content>
      @if (summaryExpanded()) {
        <div class="stat-grid">
          <div class="stat">
            <h3>{{ state.summary.total }}</h3>
            <p>Artículos totales por comprar</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.basicOut }}</h3>
            <p>Básicos sin stock</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.basicLow }}</h3>
            <p>Básicos con bajo stock</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.belowMin }}</h3>
            <p>Productos con bajo stock</p>
          </div>
        </div>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Compras sugeridas</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (loading()) {
        <div class="loading-state">
          <ion-spinner name="lines"></ion-spinner>
          <p>Generando lista de compras…</p>
        </div>
      } @else if (state.summary.total) {
        <div class="suggestion-groups">
          @for (group of state.groupedSuggestions; track group.key) {
            <div class="suggestion-group">
              <h3 class="supermarket-heading">
                {{ group.label }}
                <ion-badge color="medium">{{ group.suggestions.length }}</ion-badge>
              </h3>
              <div class="suggestion-list">
                @for (suggestion of group.suggestions; track getSuggestionTrackId(suggestion)) {
                  <ion-card class="suggestion-card">
                    <ion-card-content>
                      <div class="suggestion-header">
                        <h3>{{ suggestion.item.name }}</h3>
                        <ion-chip [color]="getBadgeColor(suggestion.reason)" [outline]="true">
                          {{ reasonLabels[suggestion.reason] }}
                        </ion-chip>
                      </div>
                      <p class="meta">
                        Destino sugerido: {{ getLocationLabel(suggestion.locationId) }} ·
                        Stock total: {{ suggestion.currentQuantity | number:'1.0-2' }} {{ getUnitLabel(suggestion.unit) }}
                        @if (suggestion.minThreshold !== undefined) {
                          · Mín.: {{ suggestion.minThreshold | number:'1.0-2' }} {{ getUnitLabel(suggestion.unit) }}
                        }
                      </p>
                      <div class="suggestion-footer">
                        <ion-note color="primary" class="purchase-note">
                          Comprar {{ suggestion.suggestedQuantity | number:'1.0-2' }} {{ getUnitLabel(suggestion.unit) }}
                        </ion-note>
                        <ion-button
                          size="small"
                          color="success"
                          fill="solid"
                          (click)="markAsPurchased(suggestion)"
                          [disabled]="isProcessing(suggestion.item._id)"
                          class="purchase-action"
                        >
                          @if (isProcessing(suggestion.item._id)) {
                            <ion-spinner slot="icon-only" name="lines-small"></ion-spinner>
                          } @else {
                            <ion-icon slot="icon-only" name="cart-outline"></ion-icon>
                          }
                        </ion-button>
                      </div>
                    </ion-card-content>
                  </ion-card>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <ion-text color="medium">
          Nada que comprar por ahora. Todo está dentro de los niveles deseados.
        </ion-text>
      }
    </ion-card-content>
  </ion-card>
</ion-content>
