<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'shopping.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  @let state = shoppingState();

  <ion-card>
    <ion-card-header class="summary-card-header">
      <div class="summary-header-content">
        <div class="summary-header-top">
          <ion-card-title>{{ 'shopping.summary.title' | translate }}</ion-card-title>
          <ion-button
            fill="clear"
            size="small"
            (click)="toggleSummary()"
            class="summary-toggle"
            [aria-expanded]="summaryExpanded()"
            [attr.aria-label]="summaryExpanded() ? ('shopping.summary.collapse' | translate) : ('shopping.summary.expand' | translate)"
          >
            <ion-icon [name]="summaryExpanded() ? 'chevron-up-outline' : 'chevron-down-outline'" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        @if (state.hasAlerts) {
          <ion-card-subtitle>
            {{ state.summary.total }}
            {{ state.summary.total === 1 ? ('shopping.summary.productOne' | translate) : ('shopping.summary.productMany' | translate) }}
            {{ 'shopping.summary.toBuyIn' | translate }}
            {{ state.summary.supermarketCount }}
            {{ state.summary.supermarketCount === 1 ? ('shopping.summary.storeOne' | translate) : ('shopping.summary.storeMany' | translate) }}.
          </ion-card-subtitle>
        } @else {
          <ion-card-subtitle>{{ 'shopping.summary.ok' | translate }}</ion-card-subtitle>
        }
      </div>
    </ion-card-header>
    <ion-card-content>
      @if (summaryExpanded()) {
        <div class="stat-grid">
          <div class="stat">
            <h3>{{ state.summary.total }}</h3>
            <p>{{ 'shopping.summary.stats.total' | translate }}</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.basicOut }}</h3>
            <p>{{ 'shopping.summary.stats.basicOut' | translate }}</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.basicLow }}</h3>
            <p>{{ 'shopping.summary.stats.basicLow' | translate }}</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.belowMin }}</h3>
            <p>{{ 'shopping.summary.stats.lowStock' | translate }}</p>
          </div>
        </div>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'shopping.suggestions.title' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (loading()) {
        <div class="loading-state">
          <ion-spinner name="lines"></ion-spinner>
          <p>{{ 'shopping.suggestions.loading' | translate }}</p>
        </div>
      } @else if (state.summary.total) {
        <div class="suggestion-groups fade-in-list">
          @for (group of state.groupedSuggestions; track group.key) {
            <div class="suggestion-group">
              <h3 class="supermarket-heading">
                {{ group.label }}
                <ion-badge color="medium">{{ group.suggestions.length }}</ion-badge>
              </h3>
              <div class="suggestion-list">
                @for (suggestion of group.suggestions; track getSuggestionTrackId(suggestion)) {
                  <ion-card class="suggestion-card">
                    <ion-card-content>
                      <div class="suggestion-header">
                        <h3>{{ suggestion.item.name }}</h3>
                        <ion-chip [color]="getBadgeColor(suggestion.reason)" [outline]="true">
                          {{ ('shopping.reasons.' + suggestion.reason) | translate }}
                        </ion-chip>
                      </div>
                      <p class="meta">
                        {{ 'shopping.suggestions.destination' | translate:{ location: getLocationLabel(suggestion.locationId) } }} ·
                        {{ 'shopping.suggestions.totalStock' | translate:{ amount: (suggestion.currentQuantity | number:'1.0-2'), unit: getUnitLabel(suggestion.unit) } }}
                        @if (suggestion.minThreshold !== undefined) {
                          · {{ 'shopping.suggestions.minStock' | translate:{ amount: (suggestion.minThreshold | number:'1.0-2'), unit: getUnitLabel(suggestion.unit) } }}
                        }
                      </p>
                      <div class="suggestion-footer">
                        <ion-button
                          size="small"
                          color="success"
                          fill="solid"
                          (click)="openPurchaseModal(suggestion)"
                          [disabled]="isProcessing(suggestion.item._id)"
                          class="purchase-action pressable"
                        >
                          @if (isProcessing(suggestion.item._id)) {
                            <ion-spinner slot="icon-only" name="lines-small"></ion-spinner>
                          } @else {
                            <ion-icon slot="icon-only" name="cart-outline"></ion-icon>
                          }
                        </ion-button>
                      </div>
                    </ion-card-content>
                  </ion-card>
                }
              </div>
            </div>
          }
        </div>
      } @else {
        <app-empty-state-generic
          class="list-empty-state"
          icon="cart-outline"
          [iconColor]="'warning'"
          [titleKey]="'emptyStates.shopping.title'"
          [subtitle]="'shopping.suggestions.empty' | translate">
        </app-empty-state-generic>
      }
    </ion-card-content>
  </ion-card>
</ion-content>
