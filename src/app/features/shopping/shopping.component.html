<ion-header>
  <ion-toolbar>
    <ion-title>Shopping</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  @let state = shoppingState();

  <ion-card>
    <ion-card-header class="summary-card-header">
      <div class="summary-header-content">
        <div class="summary-header-top">
          <ion-card-title>Shopping summary</ion-card-title>
          <ion-button
            fill="clear"
            size="small"
            (click)="toggleSummary()"
            class="summary-toggle"
            [aria-expanded]="summaryExpanded()"
            [attr.aria-label]="summaryExpanded() ? 'Collapse summary' : 'Expand summary'"
          >
            <ion-icon [name]="summaryExpanded() ? 'chevron-up-outline' : 'chevron-down-outline'" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
        @if (state.hasAlerts) {
          <ion-card-subtitle>{{ state.summary.total }} items need attention.</ion-card-subtitle>
        } @else {
          <ion-card-subtitle>All stocked items meet their targets.</ion-card-subtitle>
        }
      </div>
    </ion-card-header>
    <ion-card-content>
      @if (summaryExpanded()) {
        <div class="stat-grid">
          <div class="stat">
            <h3>{{ state.summary.total }}</h3>
            <p>Total items to buy</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.belowMin }}</h3>
            <p>Below minimum</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.basicLow }}</h3>
            <p>Basic near minimum</p>
          </div>
          <div class="stat">
            <h3>{{ state.summary.basicOut }}</h3>
            <p>Basic out of stock</p>
          </div>
        </div>
      }
      <div class="summary-actions">
        <ion-button size="small" fill="outline" (click)="refreshList()" [disabled]="loading()">
          Refresh list
        </ion-button>
      </div>
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Suggested purchases</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (loading()) {
        <div class="loading-state">
          <ion-spinner name="lines"></ion-spinner>
          <p>Generating shopping list…</p>
        </div>
      } @else if (state.suggestions.length) {
        <div class="suggestion-list">
          @for (suggestion of state.suggestions; track suggestion.item._id) {
            <ion-card class="suggestion-card">
              <ion-card-content>
                <div class="suggestion-header">
                  <h3>{{ suggestion.item.name }}</h3>
                  <ion-chip [color]="getBadgeColor(suggestion.reason)" [outline]="true">
                    {{ reasonLabels[suggestion.reason] }}
                  </ion-chip>
                </div>
                <p class="meta">
                  Current: {{ suggestion.currentQuantity | number:'1.0-2' }} {{ getUnit(suggestion.item) }}
                  @if (suggestion.minThreshold !== undefined) {
                    · Min: {{ suggestion.minThreshold | number:'1.0-2' }} {{ getUnit(suggestion.item) }}
                  }
                </p>
                <div class="suggestion-footer">
                  <ion-note color="primary" class="purchase-note">
                    Buy {{ suggestion.suggestedQuantity | number:'1.0-2' }} {{ getUnit(suggestion.item) }}
                  </ion-note>
                  <ion-button
                    size="small"
                    color="success"
                    fill="solid"
                    (click)="markAsPurchased(suggestion)"
                    [disabled]="isProcessing(suggestion.item._id)"
                    class="purchase-action"
                  >
                    @if (isProcessing(suggestion.item._id)) {
                      <ion-spinner slot="icon-only" name="lines-small"></ion-spinner>
                    } @else {
                      <ion-icon slot="icon-only" name="cart-outline"></ion-icon>
                    }
                  </ion-button>
                </div>
              </ion-card-content>
            </ion-card>
          }
        </div>
      } @else {
        <ion-text color="medium">
          Nothing to buy right now. Everything is within desired levels.
        </ion-text>
      }
    </ion-card-content>
  </ion-card>
</ion-content>
