<ion-modal
  [isOpen]="state.isOpen()"
  (willDismiss)="state.dismiss()"
  (didDismiss)="state.close()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>
          @if (state.editingItem()) { {{ 'pantry.form.editTitle' | translate }} } @else { {{ 'pantry.form.newTitle' | translate }} }
        </ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" color="medium" (click)="state.dismiss()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding create-item-modal-content">
      @if (state.selectorEnabled()) {
        <div class="entity-selector-card">
          <div class="entity-selector-card__header">
            <h3 class="entity-selector-card__title">{{ 'pantry.fastAdd.cardTitle' | translate }}</h3>
            <p class="entity-selector-card__subtitle">{{ 'pantry.fastAdd.subtitle' | translate }}</p>
          </div>
          <div class="entity-selector-card__content">
            <app-entity-autocomplete
              [items]="state.selectorOptions()"
              [placeholder]="'pantry.fastAdd.placeholder' | translate"
              [minChars]="1"
              mode="select"
              [showSecondaryInfo]="true"
              [showAllOnFocus]="true"
              [autofocus]="true"
              [emptyLabel]="'pantry.fastAdd.noResults' | translate"
              [showEmptyAction]="state.showSelectorEmptyAction()"
              [showEmptyActionWhenNoExactMatch]="true"
              [emptyActionLabel]="state.selectorEmptyActionLabel()"
              [value]="state.selectorInputValue()"
              [readonly]="state.selectorLocked()"
              [disabled]="state.selectorLocked()"
              [showClearButton]="state.selectorLocked()"
              (emptyAction)="state.onSelectorCreateNew($event)"
              (valueChange)="state.onSelectorQueryChange($event)"
              (optionSelected)="state.onSelectorSelect($event)"
              (cleared)="state.onSelectorClear()">
            </app-entity-autocomplete>
          </div>
        </div>
      }
      @if (!state.selectingItem()) {
        <form [formGroup]="state.form">
          @if (!state.selectorEnabled()) {
              <div class="form-section">
                <ion-item>
                  <ion-input
                    formControlName="name"
                    label="{{ 'pantry.form.name' | translate }}"
                    labelPlacement="stacked"
                    [placeholder]="'pantry.form.namePlaceholder' | translate"
                    required>
                  </ion-input>
                </ion-item>
              </div>
          }

          <div class="form-section-header">
            <h5>{{ 'pantry.form.details' | translate }}</h5>
          </div>
          <div class="form-section form-section--details">
            <div class="form-autocomplete form-row">
              <app-entity-autocomplete
                [items]="state.getCategoryAutocompleteOptions()"
                [label]="'pantry.form.category' | translate"
                labelPlacement="stacked"
                [placeholder]="'pantry.form.categoryPlaceholder' | translate"
                [showAllOnFocus]="true"
                [showEmptyAction]="true"
                [showEmptyActionWhenNoExactMatch]="true"
                [emptyActionLabel]="'pantry.form.categoryAdd.option' | translate"
                [emptyLabel]="'common.selects.noOptions' | translate"
                [value]="state.form.get('categoryId')?.value ?? ''"
                [clearOnSelect]="false"
                (optionSelected)="state.onCategoryAutocompleteSelect($event)"
                (emptyAction)="state.addCategoryOptionFromText($event)">
              </app-entity-autocomplete>
            </div>

            <div class="form-autocomplete form-row">
              <app-entity-autocomplete
                [items]="state.getSupermarketAutocompleteOptions()"
                [label]="'pantry.form.supermarket' | translate"
                labelPlacement="stacked"
                [placeholder]="'pantry.form.supermarketPlaceholder' | translate"
                [showAllOnFocus]="true"
                [showEmptyAction]="true"
                [showEmptyActionWhenNoExactMatch]="true"
                [emptyActionLabel]="'pantry.form.supermarketAdd.option' | translate"
                [emptyLabel]="'common.selects.noOptions' | translate"
                [value]="state.form.get('supermarket')?.value ?? ''"
                [clearOnSelect]="false"
                (optionSelected)="state.onSupermarketAutocompleteSelect($event)"
                (emptyAction)="state.addSupermarketOptionFromText($event)">
              </app-entity-autocomplete>
            </div>

            <ion-item lines="none" class="form-row">
              <ion-checkbox formControlName="isBasic" justify="space-between">
                {{ 'pantry.form.basic' | translate }}
              </ion-checkbox>
            </ion-item>

            @if (state.form.get('isBasic')?.value) {
              <ion-item lines="none" class="form-row">
                <ion-input
                  type="number"
                  min="0"
                  formControlName="minThreshold"
                  label="{{ 'pantry.form.minThreshold' | translate }}"
                  labelPlacement="stacked">
                </ion-input>
              </ion-item>
            }
          </div>

          @if (state.editingItem()) {
            <!-- Edit mode: Quantity adjuster -->
            <div class="form-section-header">
              <h5>{{ 'pantry.form.quantity.title' | translate }}</h5>
            </div>
            <div class="form-section quantity-adjuster-section">
              <span class="quantity-label">{{ 'pantry.form.quantity.current' | translate }}</span>
              <div class="quantity-controls">
                <ion-button
                  fill="clear"
                  class="control-button control-button--minus"
                  [disabled]="state.getDisplayQuantity() <= 0"
                  (click)="state.decrementQuantity()">
                  <ion-icon slot="icon-only" name="remove"></ion-icon>
                </ion-button>
                <div class="quantity-display">
                  @if (state.pendingQuantityChange() !== 0) {
                    <span class="quantity-number">
                      <span class="quantity-original">{{ state.getTotalQuantity() }}</span>
                      <ion-icon name="arrow-forward-outline" class="quantity-arrow"></ion-icon>
                      <span class="quantity-new" [class.quantity-new--negative]="state.pendingQuantityChange() < 0">{{ state.getDisplayQuantity() }}</span>
                    </span>
                  } @else {
                    <span class="quantity-number">{{ state.getTotalQuantity() }}</span>
                  }
                </div>
                <ion-button
                  fill="clear"
                  class="control-button control-button--plus"
                  (click)="state.incrementQuantity()">
                  <ion-icon slot="icon-only" name="add"></ion-icon>
                </ion-button>
              </div>
              <span class="quantity-hint">{{ 'pantry.form.quantity.hint' | translate }}</span>
            </div>
          } @else {
            <!-- Create mode: Initial quantity input -->
            <div class="form-section-header">
              <h5>{{ 'pantry.form.quantity.title' | translate }}</h5>
            </div>
            <div class="form-section">
              <ion-item lines="none">
                <ion-input
                  type="number"
                  min="0"
                  formControlName="initialQuantity"
                  label="{{ 'pantry.form.quantity.initial' | translate }}"
                  labelPlacement="stacked"
                  [placeholder]="'0'">
                </ion-input>
              </ion-item>
            </div>
          }

        </form>
      }
    </ion-content>
    @if (!state.selectingItem()) {
      <ion-footer class="modal-footer">
        <ion-toolbar>
          <ion-button
            expand="block"
            color="primary"
            [disabled]="state.isSaving() || state.form.invalid"
            (click)="state.submitItem()">
            @if (state.isSaving()) {
              <ion-spinner name="dots"></ion-spinner>
            } @else {
              {{ 'common.actions.save' | translate }}
            }
          </ion-button>
        </ion-toolbar>
      </ion-footer>
    }
  </ng-template>
</ion-modal>
