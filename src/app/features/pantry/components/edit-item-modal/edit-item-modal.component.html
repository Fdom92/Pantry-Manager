<ion-modal
  [isOpen]="state.isOpen()"
  (willDismiss)="state.dismiss()"
  (didDismiss)="state.close()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>
          @if (state.editingItem()) { {{ 'pantry.form.editTitle' | translate }} } @else { {{ 'pantry.form.newTitle' | translate }} }
        </ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" color="medium" (click)="state.dismiss()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding create-item-modal-content">
      @if (state.selectorEnabled()) {
        <div class="entity-selector-card">
          <div class="entity-selector-card__header">
            <h3 class="entity-selector-card__title">{{ 'pantry.fastAdd.cardTitle' | translate }}</h3>
            <p class="entity-selector-card__subtitle">{{ 'pantry.fastAdd.subtitle' | translate }}</p>
          </div>
          <div class="entity-selector-card__content">
            <app-entity-autocomplete
              [items]="state.selectorOptions()"
              [placeholder]="'pantry.fastAdd.placeholder' | translate"
              [minChars]="1"
              mode="select"
              [showSecondaryInfo]="true"
              [showAllOnFocus]="true"
              [autofocus]="true"
              [emptyLabel]="'pantry.fastAdd.noResults' | translate"
              [showEmptyAction]="state.showSelectorEmptyAction()"
              [showEmptyActionWhenNoExactMatch]="true"
              [emptyActionLabel]="state.selectorEmptyActionLabel()"
              [value]="state.selectorInputValue()"
              [readonly]="state.selectorLocked()"
              [disabled]="state.selectorLocked()"
              [showClearButton]="state.selectorLocked()"
              (emptyAction)="state.onSelectorCreateNew($event)"
              (valueChange)="state.onSelectorQueryChange($event)"
              (onSelect)="state.onSelectorSelect($event)"
              (onClear)="state.onSelectorClear()">
            </app-entity-autocomplete>
          </div>
        </div>
      }
      @if (!state.selectingItem()) {
        <form [formGroup]="state.form">
          @if (!state.selectorEnabled()) {
              <div class="form-section">
                <ion-item>
                  <ion-input
                    formControlName="name"
                    label="{{ 'pantry.form.name' | translate }}"
                    labelPlacement="stacked"
                    [placeholder]="'pantry.form.namePlaceholder' | translate"
                    required>
                  </ion-input>
                </ion-item>
              </div>
          }

          <div class="form-section-header">
            <h5>{{ 'pantry.form.details' | translate }}</h5>
          </div>
          <div class="form-section form-section--details">
            <div class="form-autocomplete form-row">
              <app-entity-autocomplete
                [items]="state.getCategoryAutocompleteOptions()"
                [label]="'pantry.form.category' | translate"
                labelPlacement="stacked"
                [placeholder]="'pantry.form.categoryPlaceholder' | translate"
                [showAllOnFocus]="true"
                [showEmptyAction]="true"
                [showEmptyActionWhenNoExactMatch]="true"
                [emptyActionLabel]="'pantry.form.categoryAdd.option' | translate"
                [emptyLabel]="'common.selects.noOptions' | translate"
                [value]="state.form.get('categoryId')?.value ?? ''"
                [clearOnSelect]="false"
                (onSelect)="state.onCategoryAutocompleteSelect($event)"
                (emptyAction)="state.addCategoryOptionFromText($event)">
              </app-entity-autocomplete>
            </div>

            <div class="form-autocomplete form-row">
              <app-entity-autocomplete
                [items]="state.getSupermarketAutocompleteOptions()"
                [label]="'pantry.form.supermarket' | translate"
                labelPlacement="stacked"
                [placeholder]="'pantry.form.supermarketPlaceholder' | translate"
                [showAllOnFocus]="true"
                [showEmptyAction]="true"
                [showEmptyActionWhenNoExactMatch]="true"
                [emptyActionLabel]="'pantry.form.supermarketAdd.option' | translate"
                [emptyLabel]="'common.selects.noOptions' | translate"
                [value]="state.form.get('supermarket')?.value ?? ''"
                [clearOnSelect]="false"
                (onSelect)="state.onSupermarketAutocompleteSelect($event)"
                (emptyAction)="state.addSupermarketOptionFromText($event)">
              </app-entity-autocomplete>
            </div>

            <ion-item lines="none" class="form-row">
              <ion-checkbox formControlName="isBasic" justify="space-between">
                {{ 'pantry.form.basic' | translate }}
              </ion-checkbox>
            </ion-item>

            @if (state.form.get('isBasic')?.value) {
              <ion-item lines="none" class="form-row">
                <ion-input
                  type="number"
                  min="0"
                  formControlName="minThreshold"
                  label="{{ 'pantry.form.minThreshold' | translate }}"
                  labelPlacement="stacked">
                </ion-input>
              </ion-item>
            }
          </div>

          <div class="batch-form-header">
            <h5>{{ 'pantry.form.batches.title' | translate }}</h5>
            <ion-button fill="clear" size="small" (click)="state.addBatchEntry()">
              <ion-icon slot="start" name="add-circle-outline"></ion-icon>
              {{ 'pantry.form.batches.add' | translate }}
            </ion-button>
          </div>
          <div formArrayName="batches" class="batch-form-list">
            @if (state.batchesArray.length === 0) {
              <ion-list>
                <ion-item lines="none">
                  <app-empty-state
                    class="list-empty-state"
                    icon="cube-outline"
                    [title]="'pantry.form.batches.title' | translate"
                    [subtitle]="'pantry.form.batches.empty' | translate"
                    [compact]="true">
                  </app-empty-state>
                </ion-item>
              </ion-list>
            }
            @for (batchCtrl of state.batchesArray.controls; track $index; let i = $index) {
              <div class="form-section batch-form-card" [formGroupName]="i">
                <div class="batch-form-card-header">
                  <h6>{{ 'pantry.form.batches.titleIndex' | translate:{ index: i + 1 } }}</h6>
                  <ion-button
                    fill="clear"
                    size="small"
                    color="danger"
                    (click)="state.removeBatchEntry(i)">
                    <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
                  </ion-button>
                </div>
                <ion-list lines="none" class="batch-form-listing">
                  <div class="form-autocomplete batch-row">
                    <app-entity-autocomplete
                      [items]="state.getLocationAutocompleteOptionsForBatch(i)"
                      [label]="'pantry.form.location' | translate"
                      labelPlacement="stacked"
                      [placeholder]="'pantry.form.locationPlaceholder' | translate"
                      [showAllOnFocus]="true"
                      [showEmptyAction]="true"
                      [showEmptyActionWhenNoExactMatch]="true"
                      [emptyActionLabel]="'pantry.form.locationAdd.option' | translate"
                      [emptyLabel]="'common.selects.noOptions' | translate"
                      [value]="state.batchesArray.at(i).get('locationId')?.value ?? ''"
                      [clearOnSelect]="false"
                      (onSelect)="state.onLocationAutocompleteSelect(i, $event)"
                      (emptyAction)="state.addLocationOptionFromText(i, $event)">
                    </app-entity-autocomplete>
                  </div>
                  <ion-item class="batch-row">
                    <ion-input
                      type="number"
                      min="0"
                      formControlName="quantity"
                      label="{{ 'pantry.form.batches.quantity' | translate }}"
                      labelPlacement="stacked">
                    </ion-input>
                  </ion-item>
                  <ion-item class="batch-row">
                    <ion-input
                      type="date"
                      formControlName="expirationDate"
                      label="{{ 'pantry.form.batches.expiry' | translate }}"
                      labelPlacement="stacked">
                    </ion-input>
                  </ion-item>
                  <ion-item class="batch-row" lines="none">
                    <ion-toggle formControlName="opened" justify="space-between">{{ 'pantry.form.batches.opened' | translate }}</ion-toggle>
                  </ion-item>
                </ion-list>
              </div>
            }
          </div>

        </form>
      }
    </ion-content>
    @if (!state.selectingItem()) {
      <ion-footer class="modal-footer">
        <ion-toolbar>
          <ion-button
            expand="block"
            color="primary"
            [disabled]="state.isSaving() || state.form.invalid"
            (click)="state.submitItem()">
            @if (state.isSaving()) {
              <ion-spinner name="dots"></ion-spinner>
            } @else {
              {{ 'common.actions.save' | translate }}
            }
          </ion-button>
        </ion-toolbar>
      </ion-footer>
    }
  </ng-template>
</ion-modal>
