<ion-modal
  [isOpen]="state.showBatchesModal()"
  (willDismiss)="state.dismissBatchesModal()"
  (didDismiss)="state.closeBatchesModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ 'pantry.batches.title' | translate }}</ion-title>
        <ion-buttons slot="end">
          @if (!state.batchesEditMode()) {
            <ion-button fill="clear" color="medium" (click)="state.enterBatchesEditMode()">
              <ion-icon slot="start" name="create-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" color="medium" (click)="state.dismissBatchesModal()">
              <ion-icon name="close"></ion-icon>
            </ion-button>
          }
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding batches-modal-content">
      @let selectedItem = state.selectedBatchesItem();
      @if (selectedItem) {
        <div class="batches-card">
          <div class="batches-card__header">
            <h2 class="batches-card__title">{{ selectedItem.name }}</h2>
            <p class="batches-card__subtitle">
              {{ 'pantry.batches.count' | translate:{ count: state.getTotalBatchCount(selectedItem) } }}
            </p>
          </div>

          @if (!state.batchesEditMode()) {
            <!-- Read-only view -->
            <ion-list lines="none">
              @for (entry of state.getSortedBatches(selectedItem); track entry.batch.batchId ?? entry.batch.expirationDate ?? $index) {
                <ion-item>
                  <ion-label>
                    <h3 [style.color]="'var(--ion-color-' + entry.status.color + ')'">
                      <ion-icon [name]="entry.status.icon"></ion-icon>
                      {{ state.formatBatchDate(entry.batch) }}
                    </h3>
                    <p>
                      {{ state.formatBatchQuantity(entry.batch) }}
                      @if (entry.locationLabel && entry.locationId !== 'unassigned') {
                        Â· {{ entry.locationLabel }}
                      }
                    </p>
                    @if (entry.batch.opened) {
                      <ion-badge color="tertiary" size="small">{{ 'pantry.batches.open' | translate }}</ion-badge>
                    }
                  </ion-label>
                </ion-item>
              }
            </ion-list>
          } @else {
            <!-- Edit mode -->
            <div class="edit-batches-list">
              @for (batch of state.editedBatches(); track $index) {
                <div class="edit-batch-card">
                  <div class="edit-batch-row-inline">
                    <ion-input
                      type="number"
                      min="0"
                      [value]="batch.quantity"
                      label="{{ 'pantry.form.batches.quantity' | translate }}"
                      labelPlacement="stacked"
                      (ionInput)="state.updateBatchQuantity($index, +$any($event.target).value)">
                    </ion-input>
                    <ion-input
                      type="date"
                      [value]="state.getBatchDateInputValue(batch)"
                      label="{{ 'pantry.form.batches.expiry' | translate }}"
                      labelPlacement="stacked"
                      (ionInput)="state.updateBatchExpirationDate($index, $any($event.target).value)">
                    </ion-input>
                  </div>
                  <div class="edit-batch-row">
                    <ion-select
                      [value]="batch.locationId"
                      label="{{ 'pantry.form.batches.location' | translate }}"
                      labelPlacement="stacked"
                      interface="popover"
                      (ionChange)="state.updateBatchLocation($index, $any($event.detail).value)">
                      <ion-select-option value="unassigned">{{ 'pantry.form.locationAdd.unassigned' | translate }}</ion-select-option>
                      @for (location of state.presetLocationOptions(); track location) {
                        <ion-select-option [value]="location">{{ location }}</ion-select-option>
                      }
                    </ion-select>
                  </div>
                </div>
              }
            </div>

            <!-- Edit mode actions -->
            <div class="edit-actions">
              <ion-button expand="block" fill="clear" (click)="state.cancelBatchesEditMode()">
                {{ 'common.actions.cancel' | translate }}
              </ion-button>
              <ion-button
                expand="block"
                color="primary"
                [disabled]="state.batchesIsSaving()"
                (click)="state.saveBatches()">
                @if (state.batchesIsSaving()) {
                  <ion-spinner name="dots"></ion-spinner>
                } @else {
                  {{ 'common.actions.save' | translate }}
                }
              </ion-button>
            </div>
          }
        </div>
      }
    </ion-content>
  </ng-template>
</ion-modal>
