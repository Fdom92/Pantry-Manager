<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'pantry.title' | translate }}</ion-title>
    <ion-buttons slot="end" class="header-actions">
      <ion-button fill="clear" color="text-color" size="small" (click)="facade.openFilters($event)">
        <ion-icon slot="icon-only" name="filter-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content #content class="ion-padding">
  <div class="pantry-search">
    <ion-searchbar
      [placeholder]="'pantry.filters.search' | translate"
      [value]="facade.searchTerm()"
      debounce="300"
      (ionInput)="facade.onSearchTermChange($event)">
    </ion-searchbar>
  </div>

  <div class="summary-bar" [attr.aria-label]="'pantry.filters.quick' | translate">
    <div class="summary-chips" role="tablist">
      @for (chip of facade.filterChips(); track chip.key) {
        <ion-chip
          class="status-chip"
          [class.active]="chip.active"
          [ngClass]="chip.colorClass"
          button="true"
          (click)="facade.onFilterChipSelected(chip)"
          [attr.aria-pressed]="chip.active"
          [attr.aria-label]="(chip.description | translate) + ' (' + chip.count + ')'"
          size="small">
          <ion-icon [name]="chip.icon"></ion-icon>
          <div class="chip-body">
            <span class="chip-label">{{ chip.label | translate }}</span>
            <span class="chip-count">{{ chip.count }}</span>
          </div>
        </ion-chip>
      }
    </div>
  </div>

  @if ((facade.loading() || facade.pipelineResetting()) && facade.pantryItemsState().length === 0) {
    <div class="skeleton-list">
      @for (placeholder of facade.skeletonPlaceholders; track placeholder) {
        <ion-card class="skeleton-card">
          <ion-card-header>
            <ion-skeleton-text animated style="width: 40%; height: 16px;"></ion-skeleton-text>
          </ion-card-header>
          <ion-card-content>
            <ion-skeleton-text animated style="width: 100%; height: 14px; margin-bottom: 8px;"></ion-skeleton-text>
            <ion-skeleton-text animated style="width: 80%; height: 14px;"></ion-skeleton-text>
          </ion-card-content>
        </ion-card>
      }
    </div>
  } @else if (facade.summary().total === 0) {
    <app-empty-state
      class="list-empty-state"
      icon="fast-food-outline"
      [titleKey]="'emptyStates.pantry.title'"
      [subtitleKey]="'emptyStates.pantry.subtitle'"
      [showAction]="true"
      [actionLabel]="'pantry.fastAdd.advancedAction' | translate"
      (action)="facade.openAdvancedAddModal()">
    </app-empty-state>
  } @else if (facade.pantryItemsState().length === 0) {
    <app-empty-state
      class="list-empty-state"
      icon="filter-outline"
      [subtitle]="'pantry.empty.filters' | translate">
    </app-empty-state>
  } @else {
    <div class="category-stack fade-in-list">
      @for (group of facade.groups(); track group.key) {
        <div class="virtual-category-card">
          <ion-card>
            <ion-card-header
              class="group-header"
              role="button"
              tabindex="0"
              [attr.aria-expanded]="!facade.isGroupCollapsed(group.key)"
              [attr.aria-label]="facade.isGroupCollapsed(group.key) ? ('pantry.group.expand' | translate:{ name: group.name }) : ('pantry.group.collapse' | translate:{ name: group.name })"
              (click)="facade.toggleGroupCollapse(group.key, $event)"
              (keydown)="facade.onGroupHeaderKeydown(group.key, $event)"
              [class.group-header--collapsed]="facade.isGroupCollapsed(group.key)">
              <section class="group-details">
                <div class="group-title">
                  <ion-card-title>{{ group.name }}</ion-card-title>
                </div>
                <div class="group-meta">
                  <ion-text color="medium">
                    {{ 'pantry.group.count' | translate:{ count: group.items.length } }}
                    @if (group.expiringCount) {
                      · {{ 'pantry.group.expiring' | translate:{ count: group.expiringCount } }}
                    }
                    @if (group.expiredCount) {
                      · {{ 'pantry.group.expired' | translate:{ count: group.expiredCount } }}
                    }
                  </ion-text>
                  <ion-icon
                    class="group-toggle-icon"
                    [name]="facade.isGroupCollapsed(group.key) ? 'chevron-down-outline' : 'chevron-up-outline'">
                  </ion-icon>
                </div>
              </section>
            </ion-card-header>
          </ion-card>
        </div>
        @if (!facade.isGroupCollapsed(group.key)) {
          @for (item of group.items; track facade.trackByItemId($index, item)) {
            <div
              class="virtual-item-card"
              [class.virtual-item-card--expanded]="facade.isExpanded(item)"
              [class.virtual-item-card--deleting]="facade.isDeleting(item)">
              @let card = facade.buildItemCardViewModel(item);
              <app-pantry-detail
                class="virtual-item-card__detail"
                [viewModel]="card"
                [expanded]="facade.isExpanded(item)"
                (toggleRequested)="facade.toggleItemExpansion(item, $event)"
                (summaryKeydown)="facade.onSummaryKeydown(item, $event)"
                (openBatches)="facade.openBatchesModal(item, $event)"
                (editRequested)="facade.openEditItemModal(item, $event)"
                (moveRequested)="facade.openMoveItemModal(item, $event)"
                (deleteRequested)="facade.deleteItem(item, $event)"
                (adjustBatchRequested)="facade.adjustBatchQuantity(item, $event.location, $event.batch, $event.delta, $event.event)"
              ></app-pantry-detail>
            </div>
          }
        }
      }
    </div>
  }

  <ion-modal
    [isOpen]="facade.fastAddModalOpen()"
    (willDismiss)="facade.dismissFastAddModal()"
    (didDismiss)="facade.closeFastAddModal()"
    class="fast-add-modal">
    <ng-template>
      <form class="fast-add-form" [formGroup]="facade.fastAddForm" (ngSubmit)="facade.submitFastAdd()">
        <ion-header>
          <ion-toolbar>
            <ion-title>{{ 'pantry.fastAdd.title' | translate }}</ion-title>
            <ion-buttons slot="end">
              <ion-button fill="clear" color="medium" type="button" (click)="facade.dismissFastAddModal()">
                <ion-icon name="close"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content class="ion-padding fast-add-content" [fullscreen]="true">
          <div class="fast-add-body">
            <p class="fast-add-subtitle">
              {{ 'pantry.fastAdd.subtitle' | translate }}
            </p>
            <ion-textarea
              formControlName="entries"
              autoGrow="true"
              rows="6"
              class="fast-add-textarea"
              [placeholder]="'pantry.fastAdd.placeholder' | translate">
            </ion-textarea>
          </div>
        </ion-content>
        <ion-footer class="modal-footer">
          <ion-toolbar>
            <div class="fast-add-actions">
              <ion-button expand="block" color="primary" type="submit" [disabled]="facade.isFastAdding() || !facade.hasFastAddEntries()">
                @if (facade.isFastAdding()) {
                  <ion-spinner name="dots"></ion-spinner>
                } @else {
                  {{ 'pantry.fastAdd.submit' | translate }}
                }
              </ion-button>
            </div>
          </ion-toolbar>
        </ion-footer>
      </form>
    </ng-template>
  </ion-modal>

  <app-pantry-batches-modal></app-pantry-batches-modal>
  <app-pantry-move-modal></app-pantry-move-modal>
  <app-pantry-filters-modal></app-pantry-filters-modal>
  <app-pantry-edit-item-modal></app-pantry-edit-item-modal>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="add-fab">
    <ion-fab-button color="primary" [attr.aria-label]="'pantry.fastAdd.groupLabel' | translate">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
    <ion-fab-list side="top" class="fab-options">
      <ion-fab-button
        color="primary"
        (click)="facade.openFastAddModal()"
        [attr.aria-label]="'pantry.fastAdd.cta' | translate">
        <ion-icon name="flash-outline"></ion-icon>
      </ion-fab-button>
      <ion-fab-button
        color="medium"
        (click)="facade.openAdvancedAddModal()"
        [attr.aria-label]="'pantry.fastAdd.advancedAction' | translate">
        <ion-icon name="construct-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab-list>
  </ion-fab>
</ion-content>
