<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'pantry.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content #content class="ion-padding">
  <div class="pantry-search">
    <ion-searchbar
      [placeholder]="'pantry.filters.search' | translate"
      [value]="facade.searchTerm()"
      debounce="300"
      (ionInput)="facade.onSearchTermChange($event)">
    </ion-searchbar>
  </div>

  <div class="summary-bar" [attr.aria-label]="'pantry.filters.quick' | translate">
    <div class="summary-chips" role="tablist">
      @for (chip of facade.filterChips(); track chip.key) {
        <ion-chip
          class="status-chip"
          [class.active]="chip.active"
          [ngClass]="chip.colorClass"
          button="true"
          (click)="facade.onFilterChipSelected(chip)"
          [attr.aria-pressed]="chip.active"
          [attr.aria-label]="(chip.description | translate) + ' (' + chip.count + ')'"
          size="small">
          <ion-icon [name]="chip.icon"></ion-icon>
          <div class="chip-body">
            <span class="chip-label">{{ chip.label | translate }}</span>
            <span class="chip-count">{{ chip.count }}</span>
          </div>
        </ion-chip>
      }
    </div>
  </div>

  @if ((facade.loading() || facade.pipelineResetting()) && facade.pantryItemsState().length === 0) {
    <div class="skeleton-list">
      @for (placeholder of facade.skeletonPlaceholders; track placeholder) {
        <ion-card class="skeleton-card">
          <ion-card-header>
            <ion-skeleton-text animated style="width: 40%; height: 16px;"></ion-skeleton-text>
          </ion-card-header>
          <ion-card-content>
            <ion-skeleton-text animated style="width: 100%; height: 14px; margin-bottom: 8px;"></ion-skeleton-text>
            <ion-skeleton-text animated style="width: 80%; height: 14px;"></ion-skeleton-text>
          </ion-card-content>
        </ion-card>
      }
    </div>
  } @else if (facade.summary().total === 0) {
    <app-empty-state
      class="list-empty-state"
      icon="fast-food-outline"
      [titleKey]="'emptyStates.pantry.title'"
      [subtitleKey]="'emptyStates.pantry.subtitle'">
    </app-empty-state>
  } @else if (facade.pantryItemsState().length === 0) {
    <app-empty-state
      class="list-empty-state"
      icon="filter-outline"
      [subtitle]="'pantry.empty.filters' | translate">
    </app-empty-state>
  } @else {
    <div class="category-stack fade-in-list">
      @for (group of facade.groups(); track group.key) {
        <div class="virtual-category-card">
          <ion-card>
            <ion-card-header
              class="group-header"
              role="button"
              tabindex="0"
              [attr.aria-expanded]="!facade.isGroupCollapsed(group.key)"
              [attr.aria-label]="facade.isGroupCollapsed(group.key) ? ('pantry.group.expand' | translate:{ name: group.name }) : ('pantry.group.collapse' | translate:{ name: group.name })"
              (click)="facade.toggleGroupCollapse(group.key, $event)"
              (keydown)="facade.onGroupHeaderKeydown(group.key, $event)"
              [class.group-header--collapsed]="facade.isGroupCollapsed(group.key)">
              <section class="group-details">
                <div class="group-title">
                  <ion-card-title>{{ group.name }}</ion-card-title>
                </div>
                <div class="group-meta">
                  <ion-text color="medium">
                    {{ 'pantry.group.count' | translate:{ count: group.items.length } }}
                  </ion-text>
                  <ion-icon
                    class="group-toggle-icon"
                    [name]="facade.isGroupCollapsed(group.key) ? 'chevron-down-outline' : 'chevron-up-outline'">
                  </ion-icon>
                </div>
              </section>
            </ion-card-header>
          </ion-card>
        </div>
        @if (!facade.isGroupCollapsed(group.key)) {
          @for (item of group.items; track facade.trackByItemId($index, item)) {
            <div
              class="virtual-item-card"
              [class.virtual-item-card--expanded]="facade.isExpanded(item)"
              [class.virtual-item-card--deleting]="facade.isDeleting(item)">
              @let card = facade.buildItemCardViewModel(item);
              <app-pantry-detail
                class="virtual-item-card__detail"
                [viewModel]="card"
                [expanded]="facade.isExpanded(item)"
                (toggleRequested)="facade.toggleItemExpansion(item, $event)"
                (summaryKeydown)="facade.onSummaryKeydown(item, $event)"
                (openBatches)="facade.openBatchesModal(item, $event)"
                (editRequested)="facade.openEditItemModal(item, $event)"
                (deleteRequested)="facade.deleteItem(item, $event)"
                (adjustBatchRequested)="facade.adjustBatchQuantity(item, $event.locationId, $event.batch, $event.delta, $event.event)"
              ></app-pantry-detail>
            </div>
          }
        }
      }
    </div>
  }

  <app-entity-selector-modal
    [isOpen]="facade.fastAddModalOpen()"
    [title]="'pantry.fastAdd.title' | translate"
    [cardTitle]="'pantry.fastAdd.cardTitle' | translate"
    [subtitle]="'pantry.fastAdd.subtitle' | translate"
    [placeholder]="'pantry.fastAdd.placeholder' | translate"
    [emptyLabel]="'pantry.fastAdd.noResults' | translate"
    [entriesEmptyLabel]="'pantry.fastAdd.empty' | translate"
    [saveLabel]="'pantry.fastAdd.submit' | translate"
    [saving]="facade.isFastAdding()"
    [disableSave]="!facade.hasFastAddEntries()"
    [items]="facade.fastAddOptions()"
    [entries]="facade.fastAddEntryViewModels()"
    [showSecondaryInfo]="true"
    [showMeta]="false"
    [showAllOnFocus]="true"
    [autofocus]="true"
    [showEmptyAction]="facade.showFastAddEmptyAction()"
    [emptyActionLabel]="facade.fastAddEmptyActionLabel()"
    (willDismiss)="facade.dismissFastAddModal()"
    (didDismiss)="facade.closeFastAddModal()"
    (selectItem)="facade.addFastAddEntry($event)"
    (queryChange)="facade.onFastAddQueryChange($event)"
    (emptyAction)="facade.addFastAddEntryFromQuery($event)"
    (adjustEntry)="facade.adjustFastAddEntryById($event.entry.id, $event.delta)"
    (save)="facade.submitFastAdd()">
  </app-entity-selector-modal>
  <app-pantry-batches-modal></app-pantry-batches-modal>
  <app-pantry-edit-item-modal></app-pantry-edit-item-modal>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" class="add-fab">
    <ion-fab-button
      color="primary"
      [attr.aria-label]="'pantry.fastAdd.groupLabel' | translate"
      (click)="facade.openAddModeSheet($event)">
      <ion-icon name="add-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-modal
    class="add-mode-sheet"
    [isOpen]="facade.addModeSheetOpen()"
    [initialBreakpoint]="0.28"
    [breakpoints]="[0, 0.28]"
    (didDismiss)="facade.closeAddModeSheet()">
    <ng-template>
      <ion-content class="ion-padding add-mode-content">
        <h3 class="add-mode-title">{{ 'pantry.addMode.title' | translate }}</h3>
        <ion-list class="add-mode-list">
          <ion-item button="true" detail="false" (click)="facade.selectAddModeSimple()">
            <ion-label>
              <h3>{{ 'pantry.addMode.simple' | translate }}</h3>
              <p>{{ 'pantry.fastAdd.subtitle' | translate }}</p>
            </ion-label>
          </ion-item>
          <ion-item button="true" detail="false" (click)="facade.selectAddModeAdvanced()">
            <ion-label>
              <h3>{{ 'pantry.addMode.advanced' | translate }}</h3>
              <p>{{ 'pantry.form.newTitle' | translate }}</p>
            </ion-label>
          </ion-item>
        </ion-list>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
