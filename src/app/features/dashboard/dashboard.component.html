<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'dashboard.title' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  @if (dashboardInsights().length) {
    <div class="insights-stack">
      @for (insight of dashboardInsights(); track insight.id) {
        <app-insight-card
          [insight]="insight"
          (action)="handleInsightAction($event)">
        </app-insight-card>
      }
    </div>
  }

  <ion-card>
    <ion-card-header>
      <div class="card-header-actions">
        <ion-card-title>{{ 'dashboard.summary.title' | translate }}</ion-card-title>
        <ion-button
          fill="clear"
          size="small"
          (click)="toggleSnapshot()"
          [attr.aria-expanded]="showSnapshot()"
          [attr.aria-label]="'dashboard.summary.toggle' | translate"
        >
          <ion-icon
            slot="icon-only"
            [name]="showSnapshot() ? 'chevron-up-outline' : 'chevron-down-outline'"
          ></ion-icon>
        </ion-button>
      </div>
      @if (lastUpdated()) {
        <ion-card-subtitle>
          {{ 'dashboard.summary.updated' | translate:{ value: formatLastUpdated(lastUpdated()) } }}
        </ion-card-subtitle>
      }
    </ion-card-header>
    @if (showSnapshot()) {
      <ion-card-content>
        <div class="stat-grid">
          <div class="stat">
            <h3>{{ totalItems() }}</h3>
            <p>{{ 'dashboard.summary.stats.total' | translate }}</p>
          </div>
          <div class="stat">
            <h3>{{ lowStockItems().length }}</h3>
            <p>{{ 'dashboard.summary.stats.lowStock' | translate }}</p>
          </div>
          <div class="stat">
            <h3>{{ nearExpiryItems().length }}</h3>
            <p>{{ 'dashboard.summary.stats.nearExpiry' | translate }}</p>
          </div>
          <div class="stat">
            <h3>{{ expiredItems().length }}</h3>
            <p>{{ 'dashboard.summary.stats.expired' | translate }}</p>
          </div>
        </div>
      </ion-card-content>
    }
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'dashboard.nearExpiry.title' | translate }}</ion-card-title>
      <ion-card-subtitle>
        {{ 'dashboard.nearExpiry.subtitle' | translate:{ days: nearExpiryWindow } }}
      </ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      @if (nearExpiryItems().length) {
        <ion-list lines="none" class="fade-in-list">
          @for (item of nearExpiryItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>{{ 'dashboard.nearExpiry.expires' | translate:{ date: formatDate(item.expirationDate) } }}</p>
              </ion-label>
              <ion-badge color="warning">{{ formatDate(item.expirationDate) }}</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <app-empty-state-generic
          class="list-empty-state"
          icon="hourglass-outline"
          [title]="'dashboard.nearExpiry.title' | translate"
          [subtitle]="'dashboard.nearExpiry.empty' | translate">
        </app-empty-state-generic>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'dashboard.lowStock.title' | translate }}</ion-card-title>
      <ion-card-subtitle>{{ 'dashboard.lowStock.subtitle' | translate }}</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      @if (lowStockItems().length) {
        <ion-list lines="none" class="fade-in-list">
          @for (item of lowStockItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>
                  {{ getItemTotalQuantity(item) | number:'1.0-2' }} {{ getItemUnitLabel(item) }}
                  @if (getItemTotalMinThreshold(item) > 0) {
                    ({{ 'dashboard.lowStock.minLabel' | translate:{ value: (getItemTotalMinThreshold(item) | number:'1.0-2'), unit: getItemUnitLabel(item) } }})
                  }
                </p>
                <ion-note color="medium">
                  {{ getItemLocationsSummary(item) }}
                </ion-note>
              </ion-label>
              <ion-badge color="danger">{{ getItemTotalQuantity(item) | number:'1.0-2' }}</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <app-empty-state-generic
          class="list-empty-state"
          icon="trending-down-outline"
          [title]="'dashboard.lowStock.title' | translate"
          [subtitle]="'dashboard.lowStock.empty' | translate">
        </app-empty-state-generic>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <div class="card-header-actions">
        <ion-card-title>{{ 'dashboard.expired.title' | translate }}</ion-card-title>
        @if (expiredItems().length) {
          <ion-button
            color="danger"
            fill="clear"
            size="small"
            [disabled]="deletingExpired()"
            (click)="onDeleteExpiredItems()"
            [attr.aria-label]="'dashboard.expired.deleteAria' | translate"
          >
            @if (deletingExpired()) {
              <ion-spinner slot="icon-only" name="crescent"></ion-spinner>
            } @else {
              <ion-icon slot="icon-only" name="trash-outline"></ion-icon>
            }
          </ion-button>
        }
      </div>
    </ion-card-header>
    <ion-card-content>
      @if (expiredItems().length) {
        <ion-list lines="none" class="fade-in-list">
          @for (item of expiredItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>{{ 'dashboard.expired.expires' | translate:{ date: formatDate(item.expirationDate) } }}</p>
              </ion-label>
              <ion-badge color="medium">{{ 'dashboard.expired.badge' | translate }}</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <app-empty-state-generic
          class="list-empty-state"
          icon="alert-circle-outline"
          [title]="'dashboard.expired.title' | translate"
          [subtitle]="'dashboard.expired.empty' | translate">
        </app-empty-state-generic>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>{{ 'dashboard.recent.title' | translate }}</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (recentItems().length) {
        <ion-list lines="none" class="fade-in-list">
          @for (item of recentItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>{{ 'dashboard.recent.updated' | translate:{ date: formatDate(item.updatedAt) } }}</p>
              </ion-label>
              <ion-badge color="tertiary">{{ 'dashboard.recent.badge' | translate }}</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <app-empty-state-generic
          class="list-empty-state"
          icon="time-outline"
          [title]="'dashboard.recent.title' | translate"
          [subtitle]="'dashboard.recent.empty' | translate">
        </app-empty-state-generic>
      }
    </ion-card-content>
  </ion-card>
</ion-content>
