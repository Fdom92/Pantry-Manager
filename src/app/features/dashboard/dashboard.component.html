<ion-header>
  <ion-toolbar>
    <ion-title>Panel</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card>
    <ion-card-header>
      <div class="snapshot-header">
        <ion-card-title>Resumen de la despensa</ion-card-title>
        <ion-button
          fill="clear"
          size="small"
          (click)="toggleSnapshot()"
          [attr.aria-expanded]="showSnapshot()"
          aria-label="Alternar resumen de la despensa"
        >
          <ion-icon
            slot="icon-only"
            [name]="showSnapshot() ? 'chevron-up-outline' : 'chevron-down-outline'"
          ></ion-icon>
        </ion-button>
      </div>
      @if (lastUpdated()) {
        <ion-card-subtitle>Actualizado {{ lastUpdated() | date:'short' }}</ion-card-subtitle>
      }
    </ion-card-header>
    @if (showSnapshot()) {
      <ion-card-content>
        <div class="stat-grid">
          <div class="stat">
            <h3>{{ totalItems() }}</h3>
            <p>Artículos totales</p>
          </div>
          <div class="stat">
            <h3>{{ alertCount() }}</h3>
            <p>Alertas activas</p>
          </div>
          <div class="stat">
            <h3>{{ lowStockItems().length }}</h3>
            <p>Poco stock</p>
          </div>
          <div class="stat">
            <h3>{{ nearExpiryItems().length }}</h3>
            <p>Próximo a caducar</p>
          </div>
          <div class="stat">
            <h3>{{ expiredItems().length }}</h3>
            <p>Caducados</p>
          </div>
          <div class="stat">
            <h3>{{ categoryCount() }}</h3>
            <p>Categorías registradas</p>
          </div>
          <div class="stat">
            <h3>{{ locationCount() }}</h3>
            <p>Ubicaciones utilizadas</p>
          </div>
        </div>
      </ion-card-content>
    }
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Próximos a caducar</ion-card-title>
      <ion-card-subtitle>Próximos {{ nearExpiryWindow }} días</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      @if (nearExpiryItems().length) {
        <ion-list lines="none">
          @for (item of nearExpiryItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>Caduca {{ item.expirationDate | date:'MMM d, yyyy' }}</p>
              </ion-label>
              <ion-badge color="warning">{{ item.expirationDate | date:'MMM d' }}</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <ion-text color="medium">No hay artículos próximos a caducar.</ion-text>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Alertas de poco stock</ion-card-title>
      <ion-card-subtitle>En o por debajo del nivel mínimo</ion-card-subtitle>
    </ion-card-header>
    <ion-card-content>
      @if (lowStockItems().length) {
        <ion-list lines="none">
          @for (item of lowStockItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>
                  {{ getItemTotalQuantity(item) | number:'1.0-2' }} {{ getItemUnitLabel(item) }}
                  @if (getItemTotalMinThreshold(item) > 0) {
                    (mín {{ getItemTotalMinThreshold(item) | number:'1.0-2' }} {{ getItemUnitLabel(item) }})
                  }
                </p>
                <ion-note color="medium">
                  {{ getItemLocationsSummary(item) }}
                </ion-note>
              </ion-label>
              <ion-badge color="danger">{{ getItemTotalQuantity(item) | number:'1.0-2' }}</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <ion-text color="medium">Todos los artículos están por encima de su nivel mínimo.</ion-text>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Artículos caducados</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (expiredItems().length) {
        <ion-list lines="none">
          @for (item of expiredItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>Caducó {{ item.expirationDate | date:'MMM d, yyyy' }}</p>
              </ion-label>
              <ion-badge color="medium">Caducado</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <ion-text color="medium">No hay artículos caducados en este momento.</ion-text>
      }
    </ion-card-content>
  </ion-card>

  <ion-card>
    <ion-card-header>
      <ion-card-title>Actualizados recientemente</ion-card-title>
    </ion-card-header>
    <ion-card-content>
      @if (recentItems().length) {
        <ion-list lines="none">
          @for (item of recentItems(); track item._id) {
            <ion-item lines="none">
              <ion-label>
                <h3>{{ item.name }}</h3>
                <p>Actualizado {{ item.updatedAt | date:'MMM d, yyyy' }}</p>
              </ion-label>
              <ion-badge color="tertiary">Nuevo</ion-badge>
            </ion-item>
          }
        </ion-list>
      } @else {
        <ion-text color="medium">Sin actualizaciones recientes.</ion-text>
      }
    </ion-card-content>
  </ion-card>
</ion-content>
