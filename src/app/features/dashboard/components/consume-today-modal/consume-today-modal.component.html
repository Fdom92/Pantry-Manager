<ion-modal
  [isOpen]="state.isConsumeTodayOpen()"
  (willDismiss)="state.dismissConsumeTodayModal()"
  (didDismiss)="state.closeConsumeTodayModal()">
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <ion-title>{{ 'dashboard.consumeToday.title' | translate }}</ion-title>
        <ion-buttons slot="end">
          <ion-button fill="clear" color="medium" (click)="state.dismissConsumeTodayModal()">
            <ion-icon slot="icon-only" name="close"></ion-icon>
          </ion-button>
        </ion-buttons>
      </ion-toolbar>
    </ion-header>
    <ion-content class="ion-padding consume-today-content">
      <div class="consume-today-card">
        <div class="consume-today-card__header">
          <h3 class="consume-today-card__title">{{ 'dashboard.consumeToday.cardTitle' | translate }}</h3>
          <p class="consume-today-card__subtitle">{{ 'dashboard.consumeToday.selectHint' | translate }}</p>
        </div>
        <div class="consume-today-card__content">
          <app-product-autocomplete
            [items]="state.consumeTodayOptions()"
            [placeholder]="'dashboard.consumeToday.placeholder' | translate"
            [minChars]="1"
            mode="consume"
            [showSecondaryInfo]="true"
            [showMeta]="true"
            [showAllOnFocus]="true"
            [autofocus]="true"
            [emptyLabel]="'dashboard.consumeToday.noResults' | translate"
            (onSelect)="state.addConsumeEntry($event)">
          </app-product-autocomplete>

          @if (state.consumeEntries().length) {
            <ion-list class="consume-today-list">
              @for (entry of state.consumeEntries(); track entry.itemId) {
                <ion-item class="consume-today-item">
                  <ion-label>
                    <h3>{{ entry.title }}</h3>
                  </ion-label>
                  <div class="consume-today-controls" slot="end">
                    <ion-button
                      fill="clear"
                      size="small"
                      [disabled]="entry.quantity <= 0"
                      (click)="state.adjustConsumeEntry(entry, -1)">
                      <ion-icon slot="icon-only" name="remove-outline"></ion-icon>
                    </ion-button>
                    <ion-text class="consume-today-qty">{{ entry.quantity }}</ion-text>
                    <ion-button
                      fill="clear"
                      size="small"
                      [disabled]="entry.quantity >= entry.maxQuantity"
                      (click)="state.adjustConsumeEntry(entry, 1)">
                      <ion-icon slot="icon-only" name="add-outline"></ion-icon>
                    </ion-button>
                  </div>
                </ion-item>
              }
            </ion-list>
          } @else {
            <ion-text color="medium" class="consume-today-empty">
              {{ 'dashboard.consumeToday.empty' | translate }}
            </ion-text>
          }
        </div>
      </div>
    </ion-content>
    <ion-footer class="modal-footer">
      <ion-toolbar>
        <ion-button
          expand="block"
          color="primary"
          [disabled]="!state.canSaveConsumeToday()"
          (click)="state.saveConsumeToday()">
          @if (state.consumeSaving()) {
            <ion-spinner slot="start" name="lines-small"></ion-spinner>
          }
          {{ 'dashboard.consumeToday.save' | translate }}
        </ion-button>
      </ion-toolbar>
    </ion-footer>
  </ng-template>
</ion-modal>
